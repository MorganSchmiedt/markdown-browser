/* eslint-disable */
const e=(e,t)=>"boolean"==typeof e?e:t,t=["*","[","`","!","#","~","^"].join(""),n=new RegExp(`\\\\([${t}])`,"g"),l=new RegExp(`[${t}]`),o=e=>/^\s$/.test(e),i=function(){for(const e of this.children)e._attach&&e._attach(e);this.onAttach&&this.onAttach(this)},s=(t,a={})=>{const d=e(a.allowHeader,!0),c=e(a.allowLink,!0),r=e(a.allowImage,!0),f=e(a.allowImageStyle,!1),h=e(a.allowCode,!0),p=e(a.allowMultilineCode,!0),u=e(a.allowUnorderedList,!0),C=e(a.allowUnorderedNestedList,!0),g=e(a.allowOrderedList,!0),L=e(a.allowOrderedNestedList,!0),O=e(a.allowHorizontalLine,!0),x=e(a.allowQuote,!0),N=e(a.allowFootnote,!1),m=(b=a.maxHeader,A=3,Number.isInteger(b)&&b>=1&&b<=6?b:A);var b,A;const w=a.document||window.document,E=e=>{const t=w.createElement(e);return t._attach=i,t},I=w.createElement("div");let U=0;const T=`${t}\n`,R=T.length;let P,H,M,S,$;const G={},v=[],y=()=>{null!=P&&(I.appendChild(P),I.lastChild._attach(),P=null,H=null)},Q=()=>{if(null==H&&(P=E("P"),H=P),M<S){const e=(e=>e.replace(n,((e,t)=>t)))($.substring(M,S));H.appendChild(w.createTextNode(e)),M=S}},B=e=>$[S+e];for(;U<R;){const e=T.substring(U),t=e.indexOf("\n");$=e.substring(0,t);let n=t+1,i=!1;if(0===$.trim().length)null!=P&&"P"===P.tagName&&y();else{S=0,M=0;let e=!0;const s=$[0];if("\\"===s)S=1;else if(d&&"#"===s){let t=1;for(;t<m&&"#"===B(t);)t+=1;if(" "===B(t)){y();const n=$.substring($.indexOf(" ")+1),l=E(`H${t}`);l.textContent=n,l.onAttach=a.onHeader,P=l,e=!1,y()}}else if("!"===s){if("["===B(1)&&r){const t=$.substring(S+1),n=/^\[([^\]]+)]\(([^;)]+)(;([^)]+))?\)$/.exec(t);if(n){y();const t=n[1],l=n[2],o=n[4],i=E("FIGURE");f&&null!=o&&i.setAttribute("style",o);if(l.endsWith(".mp4")){const e=E("SOURCE");e.setAttribute("src",l),e.setAttribute("type","video/mp4");const t=E("VIDEO");t.appendChild(e),t.setAttribute("controls",""),t.onAttach=a.onVideo,i.appendChild(t)}else{const e=E("IMG");e.setAttribute("src",l),e.setAttribute("alt",""),e.onAttach=a.onImage,i.appendChild(e)}const s=E("FIGCAPTION");s.textContent=t,i.appendChild(s),P=i,e=!1,y()}}}else if("-"===s){if(O&&"---"===$&&"\n"===T[U-2]&&"\n"===T[U-1]&&"\n"===T[U+3]&&"\n"===T[U+4]){y();const t=E("HR");t.onAttach=a.onHorizontalLine,P=t,e=!1,y()}else if(u&&" "===B(1)){if(null!=P&&"UL"!==P.tagName&&y(),null==P){const e=E("UL");e.onAttach=a.onUnorderedList,e.appendChild(E("LI")),P=e}else P.appendChild(E("LI"));H=P.lastChild,S=2,M=S,i=!0}}else if(g&&Number.isInteger(parseInt(s,10))){const e=/^([0-9]+)\. /.exec($);if(e){const t=e[0].length;if(null!=P&&"OL"!==P.tagName&&y(),null==P){const e=E("OL");e.onAttach=a.onOrderedList,e.appendChild(E("LI")),P=e}else P.appendChild(E("LI"));H=P.lastChild,S=t,M=S,i=!0}}else if(" "===s&&" "===B(1)){const e=/^([ ]{2,})((- )|(\d+\. ))?/.exec($),t=e[0].length,n=e[1].length,l=null!=e[2],o="- "===e[2]?"UL":"OL";if((!1===l&&null!=H&&null!=H.parentNode&&"UL"===H.parentNode.tagName&&n>=2||!1===l&&null!=H&&"OL"===H.parentNode.tagName&&n>=3)&&("LI"===H.tagName&&H.appendChild(E("BR")),S+=t,M+=t,i=!0),l&&null!=H&&null!=H.parentNode&&(C&&"UL"===P.tagName&&n>=2||L&&"OL"===P.tagName&&n>=3)){let e=0,n=H;for(;null!=n;)"UL"!==n.tagName&&"OL"!==n.tagName||(e+=1),n=n.parentNode;const l=H.parentNode,s=l.lastChild;if(2===e&&H.parentNode.tagName===o)l.appendChild(E("LI")),H=l.lastChild;else{const e=E(o);e.onAttach="UL"===o?a.onUnorderedList:a.onOrderedList,e.appendChild(E("LI")),s.appendChild(e),H=s.lastChild.lastChild}S=t,M=S,i=!0}}else if(x&&">"===s){if(" "===B(1)){if(null!=P&&"BLOCKQUOTE"===P.tagName||y(),null==P){const e=E("P"),t=E("BLOCKQUOTE");t.onAttach=a.onQuote,t.appendChild(e),P=t,H=e}else if("BLOCKQUOTE"===P.tagName&&1===$.trim().length){const e=E("P");P.appendChild(e),H=e}S=2,M=S,i=!0}}else if(p&&$.startsWith("```")){const t=/^```(\w*)\n((.|\n(?!```))+)\n```/.exec(T.substring(U));if(t){y();const l=t[0].length,o=t[1],i=t[2],s=E("CODE");s.textContent=i.replace(/\\`/g,"`");const d=E("PRE");d.appendChild(s),d.onAttach=null!=a.onMultilineCode?e=>a.onMultilineCode(e,o):void 0,P=d,y(),n=l,e=!1}}else if(N&&"["===s){const t=/^\[\^([\d\w]+)\]: (.+)/.exec($);if(t){y();const n=t[1],l=t[2];G[n]=l,e=!1}}if(e){let e;for(!1===i&&null!=P&&"P"!==P.tagName&&y(),null!=H&&"P"===H.tagName&&null!=H.firstChild&&H.appendChild(E("BR"));S<=t;){let t=0;const n=l.exec($.substring(S,e));if(null==n){if(null==e){S=$.length,Q();break}for(S=e,Q(),S+=H.ffOnTextEnd,M+=H.ffOnTextEnd;H.upOnTextEnd;)H=H.parentNode;H=H.parentNode,e=void 0}else{const l=n[0];if(t=1,S+=n.index,"\\"===B(-1));else if("*"===l){if(null==H||"EM"!==H.tagName&&"STRONG"!==H.tagName){const n=$.substring(S),l=/^(\*{1,3})/.exec(n)[0],i=l.length,s=n[i];if(!1===o(s)){const t=/(.+?)(?=\S\*)/.exec(n.substr(i));if(t){const n=t[0].length+i+1;if(Q(),e=S+n,"*"===l){const e=E("EM");e.ffOnTextEnd=i,H.appendChild(e),H=e}else if("**"===l){const e=E("STRONG");e.ffOnTextEnd=i,H.appendChild(e),H=e}else{const e=E("EM");e.ffOnTextEnd=i,e.upOnTextEnd=!0;const t=E("STRONG");t.appendChild(e),H.appendChild(t),H=e}M+=i}}t=i}}else if("~"===l){if("~"===B(1)){const n="~~",l=n.length,o=S+l,i=$.substring(o).indexOf(n);if(i>0){Q(),e=o+i;const n=E("S");n.ffOnTextEnd=l,H.appendChild(n),H=n,t=l,M+=l}}}else if("^"===l){const e=1,n=$.substring(S+e),l=("("===n[0]?/^\(([^)]+)\)/:/^(\w+)/).exec(n);if(l){Q();const n=l[0].length,o=l[1],i=E("SUP");i.textContent=o,H.appendChild(i),t=e+n,M+=t}}else if("["===l){const e=$.substring(S+1);if(N&&"^"===B(1)){const n=/\^([\d\w]+)]/.exec(e);if(n){Q();const e=n[1],l=v.length+1;v.push(e);const o=E("SUP");o.textContent=l;const i=E("A");i.setAttribute("href",`#reference${l}`),i.appendChild(o),i.onAttach=null!=a.onReference?t=>a.onReference(t,e):void 0,H.appendChild(i),t=1+n[0].length,M+=t}}else if(c){const n=/([^\]]+)]\(([^)]+)\)/.exec(e);if(n){Q();const e=n[1],l=n[2],o=E("A");o.setAttribute("href",l),o.textContent=e,o.onAttach=a.onLink,H.appendChild(o),t=1+n[0].length,M+=t}}}else if("!"===l&&"["===B(1)){if(r){const e=$.substring(S+1),n=/^\[([^\]]+)]\(([^;)]+)\)({([^}]+)})?/.exec(e);if(n){Q();const e=1+n[0].length,l=n[1],o=n[2],i=n[4],s=E("IMG");s.onAttach=a.onImage,s.setAttribute("src",o),s.setAttribute("alt",l),f&&null!=i&&s.setAttribute("style",i),H.appendChild(s),t=e,M+=t}}}else if(h&&"`"===l){const e=$.substring(S+1),n=e.indexOf("`");if(n>0){Q();const l=e.substring(0,n),o=E("CODE");o.textContent=l,o.onAttach=a.onCode,H.appendChild(o),t=1+n+1,M+=t}}}S+=t}}}U+=n}if(P&&y(),N){const e=E("ol");let t=1;for(const n of v){const l=G[n];if(null!=l){const n=s(l,Object.assign({},a,{allowHeader:!1,allowImage:!1,allowMultilineCode:!1,allowUnorderedList:!1,allowOrderedList:!1,allowHorizontalLine:!1,allowQuote:!1,allowFootnote:!1})).firstChild,o=E("li");o.id=`reference${t}`;for(const e of Array.from(n.childNodes))o.appendChild(e);e.appendChild(o),t+=1}}if(e.children.length>0){const t=E("section");t.appendChild(e),I.appendChild(t)}}return I};export default{parse:s};